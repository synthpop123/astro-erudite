---
import Link from '@/components/Link.astro'
import { Icon } from 'astro-icon/components'
import { SUBSTATS } from '@/consts'
import type { SubstatsItem } from '@/types'

// Make a shallow copy to avoid mutating the imported constant
const stats: SubstatsItem[] = SUBSTATS.map((s) => ({ ...s }))

async function fetchCount(item: SubstatsItem) {
  if (!item.api) return
  const response = await fetch(`https://api.swo.moe/stats/${item.api}`)
  const data = await response.json()
  if (data.failed) {
    console.error(data.message)
  } else {
    item.count = data.count
  }
}

for (let item of stats) {
  await fetchCount(item)
}
---

<div class="grid grid-cols-1 gap-3 rounded-xl border p-2 sm:grid-cols-2 sm:p-3">
  {
    stats.map(({ link, platform, icon, color, count, text }) => (
      <a
        class="group text-muted-foreground no-underline"
        href={link}
        target="_blank"
        rel="noopener noreferrer"
      >
        <div class="hover:border-border hover:bg-muted flex items-center gap-3 rounded-lg border border-transparent px-3 py-2 transition-all">
          {icon && (
            <Icon
              name={icon}
              class="size-6"
              style={{
                color: color
                  ? color
                  : 'hsl(var(--foreground) / var(--tw-text-opacity))',
              }}
            />
          )}
          <div class="text-foreground group-hover:text-primary flex-1 transition-colors">
            {platform}
          </div>
          <div class="flex items-center gap-1.5">
            <samp>{count}</samp>
            <span class="text-sm font-normal">{text}</span>
          </div>
        </div>
      </a>
    ))
  }
</div>
<div class="prose-neutral dark:prose-invert mt-2 text-right text-sm">
  Powered by <Link
    class="text-foreground"
    href="https://github.com/spencerwooo/substats"
    external
    underline>Substats</Link
  >
</div>
